<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Smart AC Controller</title>

		<!-- Tailwind CSS -->
		<script src="https://cdn.tailwindcss.com"></script>

		<!-- Google Fonts -->
		<link
			href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap"
			rel="stylesheet"
		/>

		<!-- Chart.js -->
		<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

		<style>
			:root {
				--bg-color: #4f83e4;
				--card-bg: rgba(255, 255, 255, 0.85);
				--border-color: #000000;
				--accent-color: #ff4d4d;
				--success-color: #34c759;
			}

			body {
				font-family: "Press Start 2P", cursive;
				background-color: var(--bg-color);
				background-image: linear-gradient(
						transparent 95%,
						rgba(0, 0, 0, 0.1) 50%
					),
					linear-gradient(
						90deg,
						transparent 95%,
						rgba(0, 0, 0, 0.1) 50%
					);
				background-size: 20px 20px;
				image-rendering: pixelated;
			}

			/* --- PIXEL ART CLOUDS --- */
			.cloud {
				width: 120px;
				height: 40px;
				background: #fff;
				position: absolute;
				border: 4px solid #000;
				box-shadow: 8px 8px 0px rgba(0, 0, 0, 0.2);
				z-index: -1;
			}
			.cloud::after {
				content: "";
				position: absolute;
				top: -20px;
				left: 20px;
				width: 40px;
				height: 20px;
				background: #fff;
				border: 4px solid #000;
				border-bottom: none;
			}
			.c1 {
				top: 10%;
				left: -20%;
				animation: float 25s linear infinite;
			}
			.c2 {
				top: 30%;
				left: -20%;
				animation: float 35s linear infinite 5s;
				transform: scale(0.8);
			}
			.c3 {
				top: 60%;
				left: -20%;
				animation: float 40s linear infinite 12s;
				transform: scale(0.6);
			}

			@keyframes float {
				0% {
					left: -150px;
				}
				100% {
					left: 110%;
				}
			}

			/* --- SUN --- */
			.sun {
				position: fixed;
				top: 40px;
				right: 40px;
				width: 60px;
				height: 60px;
				background: #ffd700;
				border: 4px solid #000;
				box-shadow: 8px 8px 0px #000;
				z-index: -2;
			}

			/* --- RETRO COMPONENTS --- */
			.retro-card {
				background: var(--card-bg);
				border: 4px solid var(--border-color);
				box-shadow: 8px 8px 0px var(--border-color);
				transition: transform 0.1s;
			}

			.retro-btn {
				background: #fff;
				border: 4px solid #000;
				box-shadow: 4px 4px 0px #000;
				cursor: pointer;
				transition: all 0.1s;
				display: flex;
				align-items: center;
				justify-content: center;
			}
			.retro-btn:active {
				transform: translate(4px, 4px);
				box-shadow: none !important;
			}
			.retro-btn.active {
				background: #000;
				color: #fff;
			}
			.retro-btn.active svg {
				fill: #fff;
			}
			.retro-btn:disabled {
				opacity: 0.5;
				cursor: not-allowed;
				transform: none;
				box-shadow: 4px 4px 0px #000;
			}

			.power-btn-active {
				background-color: var(--success-color) !important;
				color: #000 !important;
			}

			.status-dot {
				width: 16px;
				height: 16px;
				background: var(--accent-color);
				border: 3px solid #000;
				box-shadow: 2px 2px 0px #000;
			}
			.status-dot.connected {
				background: var(--success-color);
			}

			/* Chart Canvas Fix */
			canvas {
				image-rendering: pixelated;
			}
		</style>
	</head>
	<body
		class="min-h-screen p-2 md:p-6 flex flex-col items-center justify-center"
	>
		<!-- Background Elements -->
		<div class="sun hidden md:block"></div>
		<div class="fixed inset-0 pointer-events-none overflow-hidden">
			<div class="cloud c1"></div>
			<div class="cloud c2"></div>
			<div class="cloud c3"></div>
		</div>

		<!-- Dashboard Container -->
		<div
			class="w-full max-w-4xl grid grid-cols-1 lg:grid-cols-12 gap-4 relative z-10"
		>
			<!-- HEADER -->
			<div
				class="lg:col-span-12 retro-card p-3 flex justify-between items-center bg-white"
			>
				<div>
					<h1
						class="text-[0.6rem] md:text-xs uppercase mb-1 text-gray-500"
					>
						Device
					</h1>
					<h2
						class="text-xs md:text-lg font-bold uppercase leading-tight"
					>
						Master Bedroom
					</h2>
				</div>
				<div class="flex items-center gap-2">
					<span
						class="text-[0.5rem] uppercase hidden sm:inline"
						id="statusText"
						>Offline</span
					>
					<div id="connDot" class="status-dot"></div>
				</div>
			</div>

			<!-- LEFT COLUMN: MAIN CONTROLS -->
			<div class="lg:col-span-5 flex flex-col gap-4">
				<!-- Temperature Display Card -->
				<div
					class="retro-card p-4 flex flex-col items-center justify-center text-center h-full"
				>
					<div
						class="relative w-36 h-36 md:w-44 md:h-44 bg-gray-100 border-4 border-black shadow-inner flex flex-col items-center justify-center mb-4"
					>
						<div
							class="absolute inset-0 shadow-[inset_4px_4px_0px_rgba(0,0,0,0.1)] pointer-events-none"
						></div>

						<span class="text-[0.6rem] text-gray-500 mb-2"
							>CURRENT</span
						>
						<div class="flex items-baseline">
							<span
								id="tempValue"
								class="text-3xl md:text-4xl font-bold"
								>--</span
							>
							<span class="text-lg md:text-xl ml-1">°C</span>
						</div>

						<div class="mt-2 flex items-center gap-2 text-[0.6rem]">
							<span>HUM:</span>
							<span id="humidityValue" class="font-bold">--</span
							>%
						</div>
					</div>

					<!-- Temp Controls -->
					<div class="flex items-center gap-3 w-full justify-center">
						<button
							id="tempDownBtn"
							onclick="updateTemp(-1)"
							class="retro-btn w-10 h-10 text-lg font-bold bg-white hover:bg-gray-50"
						>
							-
						</button>

						<div class="flex flex-col items-center w-20">
							<span class="text-[0.5rem] text-gray-500 mb-1"
								>TARGET</span
							>
							<span class="text-xl font-bold"
								><span id="targetTemp">--</span>°C</span
							>
						</div>

						<button
							id="tempUpBtn"
							onclick="updateTemp(1)"
							class="retro-btn w-10 h-10 text-lg font-bold bg-white hover:bg-gray-50"
						>
							+
						</button>
					</div>

					<!-- Power Button -->
					<button
						id="powerBtn"
						onclick="togglePower()"
						class="retro-btn w-full mt-5 py-3 text-red-500 hover:bg-red-50 gap-2 font-bold text-sm"
					>
						<svg class="w-5 h-5 fill-current" viewBox="0 0 24 24">
							<path
								d="M13 3h-2v10h2V3zm4.83 2.17l-1.42 1.42C17.99 7.86 19 9.81 19 12c0 3.87-3.13 7-7 7s-7-3.13-7-7c0-2.19 1.01-4.14 2.58-5.42L6.17 5.17C4.23 6.82 3 9.26 3 12c0 4.97 4.03 9 9 9s9-4.03 9-9c0-2.74-1.23-5.18-3.17-6.83z"
							/>
						</svg>
						<span>POWER <span id="powerText">OFF</span></span>
					</button>
				</div>
			</div>

			<!-- RIGHT COLUMN: MODES & STATS -->
			<div class="lg:col-span-7 flex flex-col gap-4">
				<!-- Mode, Fan & Swing -->
				<div class="retro-card p-4">
					<h3
						class="text-[0.6rem] uppercase underline decoration-2 mb-3"
					>
						Operation Mode
					</h3>
					<div class="grid grid-cols-3 gap-3 mb-5">
						<button
							onclick="setMode('cool')"
							id="mode-cool"
							class="retro-btn py-2 px-2 flex-col gap-1"
						>
							<svg
								class="w-5 h-5 fill-current"
								viewBox="0 0 24 24"
							>
								<path
									d="M14 6V4h-4v2h4zM4 8v11h16V8H4zm16-2c1.11 0 2 .89 2 2v11c0 1.11-.89 2-2 2H4c-1.11 0-2-.89-2-2V8c0-1.11.89-2 2-2h16z"
								/>
							</svg>
							<span class="text-[0.5rem]">COOL</span>
						</button>
						<button
							onclick="setMode('dry')"
							id="mode-dry"
							class="retro-btn py-2 px-2 flex-col gap-1"
						>
							<svg
								class="w-5 h-5 fill-current"
								viewBox="0 0 24 24"
							>
								<path
									d="M12 2c-5.33 4.55-8 8.48-8 11.8 0 4.98 3.8 8.2 8 8.2s8-3.22 8-8.2c0-3.32-2.67-7.25-8-11.8zm0 18c-3.35 0-6-2.57-6-6.2 0-2.34 1.95-5.44 6-9.14 4.05 3.7 6 6.8 6 9.14 0 3.63-2.65 6.2-6 6.2z"
								/>
							</svg>
							<span class="text-[0.5rem]">DRY</span>
						</button>
						<button
							onclick="setMode('fan')"
							id="mode-fan"
							class="retro-btn py-2 px-2 flex-col gap-1"
						>
							<svg
								class="w-5 h-5 fill-current"
								viewBox="0 0 24 24"
							>
								<path
									d="M12 11c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1m0-9c5.52 0 10 4.48 10 10s-4.48 10-10 10S2 17.52 2 12 6.48 2 12 2m0 18c4.41 0 8-3.59 8-8s-3.59-8-8-8-8 3.59-8 8 3.59 8 8 8z"
								/>
							</svg>
							<span class="text-[0.5rem]">FAN</span>
						</button>
					</div>

					<h3
						class="text-[0.6rem] uppercase underline decoration-2 mb-3"
					>
						Fan Speed
					</h3>
					<div
						class="flex border-4 border-black shadow-[4px_4px_0px_#000] bg-white mb-5"
					>
						<button
							onclick="setFan('low')"
							id="fan-low"
							class="flex-1 py-2 text-[0.5rem] border-r-4 border-black hover:bg-gray-100"
						>
							LOW
						</button>
						<button
							onclick="setFan('med')"
							id="fan-med"
							class="flex-1 py-2 text-[0.5rem] border-r-4 border-black hover:bg-gray-100"
						>
							MED
						</button>
						<button
							onclick="setFan('high')"
							id="fan-high"
							class="flex-1 py-2 text-[0.5rem] border-r-4 border-black hover:bg-gray-100"
						>
							HI
						</button>
						<button
							onclick="setFan('auto')"
							id="fan-auto"
							class="flex-1 py-2 text-[0.5rem] bg-black text-white hover:bg-gray-800"
						>
							AUTO
						</button>
					</div>

					<!-- SWING CONTROL ADDED HERE -->
					<h3
						class="text-[0.6rem] uppercase underline decoration-2 mb-3"
					>
						Swing
					</h3>
					<div
						class="flex border-4 border-black shadow-[4px_4px_0px_#000] bg-white"
					>
						<button
							onclick="setSwing('on')"
							id="swing-on"
							class="flex-1 py-2 text-[0.5rem] border-r-4 border-black hover:bg-gray-100"
						>
							ON
						</button>
						<button
							onclick="setSwing('off')"
							id="swing-off"
							class="flex-1 py-2 text-[0.5rem] bg-black text-white hover:bg-gray-800"
						>
							OFF
						</button>
					</div>
				</div>

				<!-- Tabbed Charts -->
				<div
					class="retro-card p-0 flex-1 flex flex-col min-h-[350px] overflow-hidden"
				>
					<!-- Tabs Header -->
					<div class="flex border-b-4 border-black">
						<button
							onclick="switchTab('temp')"
							id="tab-temp"
							class="flex-1 py-3 text-[0.6rem] font-bold bg-black text-white hover:opacity-90"
						>
							TEMP
						</button>
						<button
							onclick="switchTab('humidity')"
							id="tab-hum"
							class="flex-1 py-3 text-[0.6rem] font-bold bg-white text-black border-l-4 border-black hover:bg-gray-100"
						>
							HUMIDITY
						</button>
					</div>

					<!-- Tab Content -->
					<div class="relative flex-1 w-full bg-white">
						<div
							id="view-temp"
							class="absolute inset-0 p-2 w-full h-full"
						>
							<div class="w-full h-full relative">
								<canvas id="tempChart"></canvas>
							</div>
						</div>
						<div
							id="view-hum"
							class="absolute inset-0 p-2 w-full h-full hidden"
						>
							<div class="w-full h-full relative">
								<canvas id="humidityChart"></canvas>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- Socket.IO -->
		<script src="/socket.io/socket.io.js"></script>

		<!-- App Scripts -->
		<script>
			// --- CONFIG & STATE ---
			let state = {
				temperature: null,
				humidity: null,
				targetTemp: 25,
				power: false,
				mode: "cool",
				fanSpeed: "auto",
				swing: "off", // Added swing state
				history: [],
				humidityHistory: [],
			};

			let tempChart, humidityChart;
			let socket;

			// --- CHART SETUP ---
			const commonOptions = {
				responsive: true,
				maintainAspectRatio: false,
				animation: false,
				elements: { point: { radius: 2, hoverRadius: 4 } },
				plugins: { legend: { display: false } },
				scales: {
					x: { display: false },
					y: {
						display: true,
						position: "right",
						ticks: {
							font: { family: "'Press Start 2P'", size: 8 },
							color: "#000",
							stepSize: 1,
						},
						grid: {
							display: true,
							drawBorder: false,
							color: "#e5e5e5",
						},
					},
				},
			};

			function initCharts() {
				// Temp Chart
				const ctxT = document
					.getElementById("tempChart")
					.getContext("2d");
				tempChart = new Chart(ctxT, {
					type: "line",
					data: {
						labels: [],
						datasets: [
							{
								data: [],
								borderColor: "#000",
								borderWidth: 3,
								backgroundColor: "rgba(0,0,0,0.05)",
								fill: true,
								tension: 0.1,
							},
						],
					},
					options: {
						...commonOptions,
						scales: {
							...commonOptions.scales,
							y: { ...commonOptions.scales.y, min: 16, max: 32 },
						},
					},
				});

				// Humidity Chart
				const ctxH = document
					.getElementById("humidityChart")
					.getContext("2d");
				humidityChart = new Chart(ctxH, {
					type: "line",
					data: {
						labels: [],
						datasets: [
							{
								data: [],
								borderColor: "#4f83e4",
								borderWidth: 3,
								backgroundColor: "rgba(79, 131, 228, 0.1)",
								fill: true,
								tension: 0.1,
							},
						],
					},
					options: {
						...commonOptions,
						scales: {
							...commonOptions.scales,
							y: { ...commonOptions.scales.y, min: 30, max: 90 },
						},
					},
				});
			}

			// --- TAB SWITCHING ---
			function switchTab(tab) {
				const btnTemp = document.getElementById("tab-temp");
				const btnHum = document.getElementById("tab-hum");
				const viewTemp = document.getElementById("view-temp");
				const viewHum = document.getElementById("view-hum");

				if (tab === "temp") {
					btnTemp.classList.add("bg-black", "text-white");
					btnTemp.classList.remove(
						"bg-white",
						"text-black",
						"hover:bg-gray-100"
					);

					btnHum.classList.remove("bg-black", "text-white");
					btnHum.classList.add(
						"bg-white",
						"text-black",
						"hover:bg-gray-100"
					);

					viewTemp.classList.remove("hidden");
					viewHum.classList.add("hidden");
				} else {
					btnTemp.classList.remove("bg-black", "text-white");
					btnTemp.classList.add(
						"bg-white",
						"text-black",
						"hover:bg-gray-100"
					);

					btnHum.classList.add("bg-black", "text-white");
					btnHum.classList.remove(
						"bg-white",
						"text-black",
						"hover:bg-gray-100"
					);

					viewTemp.classList.add("hidden");
					viewHum.classList.remove("hidden");
				}
			}

			// --- NETWORK & UI ---

			// Initialize Socket & Charts on Load
			window.onload = function () {
				initCharts();

				// Connect to server
				if (typeof io !== "undefined") {
					socket = io();

					socket.on("connect", () => {
						document.getElementById("statusText").innerText =
							"Online";
						document
							.getElementById("connDot")
							.classList.add("connected");
						socket.emit("request_state");
					});

					socket.on("disconnect", () => {
						document.getElementById("statusText").innerText =
							"Offline";
						document
							.getElementById("connDot")
							.classList.remove("connected");
					});

					socket.on("web_update", (data) => {
						// Filter out undefined values to protect state
						const cleanData = Object.fromEntries(
							Object.entries(data).filter(
								([_, v]) => v !== undefined && v !== null
							)
						);
						state = { ...state, ...cleanData };
						renderUI();
					});
				} else {
					console.error(
						"Socket.IO not loaded. Is the server running?"
					);
				}
			};

			// Send Command via REST API
			async function sendCommand(data) {
				try {
					await fetch("/api/command", {
						method: "POST",
						headers: { "Content-Type": "application/json" },
						body: JSON.stringify(data),
					});
				} catch (e) {
					console.error("Error sending command:", e);
				}
			}

			// --- CONTROL FUNCTIONS ---

			function togglePower() {
				const newVal = !state.power;
				// Optimistic update
				state.power = newVal;
				renderUI();
				sendCommand({ action: "power", value: newVal });
			}

			function setMode(m) {
				state.mode = m;
				renderUI();
				sendCommand({ action: "set_mode", value: m });
			}

			function setFan(f) {
				state.fanSpeed = f;
				renderUI();
				sendCommand({ action: "set_fan", value: f });
			}

			function setSwing(s) {
				state.swing = s;
				renderUI();
				sendCommand({ action: "set_swing", value: s });
			}

			function updateTemp(change) {
				let newTemp = state.targetTemp + change;
				if (newTemp >= 18 && newTemp <= 32) {
					state.targetTemp = newTemp;
					renderUI();
					sendCommand({ action: "temp", value: newTemp });
				}
			}

			// --- RENDER FUNCTION ---
			function renderUI() {
				// Temp & Hum Display
				// Rounding to integers as requested
				document.getElementById("tempValue").innerText =
					state.temperature !== null
						? Math.round(state.temperature)
						: "--";
				document.getElementById("humidityValue").innerText =
					state.humidity !== null ? Math.round(state.humidity) : "--";

				// Target Temp
				document.getElementById("targetTemp").innerText =
					state.targetTemp;

				// Disable buttons logic
				document.getElementById("tempDownBtn").disabled =
					state.targetTemp <= 18;
				document.getElementById("tempUpBtn").disabled =
					state.targetTemp >= 32;

				// Power Button State
				const pBtn = document.getElementById("powerBtn");
				const pTxt = document.getElementById("powerText");
				if (state.power) {
					pBtn.classList.add("power-btn-active", "text-black");
					pBtn.classList.remove("text-red-500");
					pTxt.innerText = "ON";
				} else {
					pBtn.classList.remove("power-btn-active", "text-black");
					pBtn.classList.add("text-red-500");
					pTxt.innerText = "OFF";
				}

				// Mode Active State
				document
					.querySelectorAll('[id^="mode-"]')
					.forEach((el) => el.classList.remove("active"));
				const mBtn = document.getElementById("mode-" + state.mode);
				if (mBtn) mBtn.classList.add("active");

				// Fan Active State
				document.querySelectorAll('[id^="fan-"]').forEach((el) => {
					el.classList.remove("bg-black", "text-white");
					el.classList.add("hover:bg-gray-100");
				});
				const fBtn = document.getElementById("fan-" + state.fanSpeed);
				if (fBtn) {
					fBtn.classList.add("bg-black", "text-white");
					fBtn.classList.remove("hover:bg-gray-100");
				}

				// Swing Active State
				document.querySelectorAll('[id^="swing-"]').forEach((el) => {
					el.classList.remove("bg-black", "text-white");
					el.classList.add("hover:bg-gray-100");
				});
				const sBtn = document.getElementById("swing-" + state.swing);
				if (sBtn) {
					sBtn.classList.add("bg-black", "text-white");
					sBtn.classList.remove("hover:bg-gray-100");
				}

				// Update Charts
				if (tempChart && state.history) {
					// Ensure labels array length matches data length to avoid Chart.js errors
					if (tempChart.data.labels.length !== state.history.length) {
						tempChart.data.labels = Array(
							state.history.length
						).fill("");
					}
					tempChart.data.datasets[0].data = state.history;
					tempChart.update();
				}

				if (humidityChart && state.humidityHistory) {
					if (
						humidityChart.data.labels.length !==
						state.humidityHistory.length
					) {
						humidityChart.data.labels = Array(
							state.humidityHistory.length
						).fill("");
					}
					humidityChart.data.datasets[0].data = state.humidityHistory;
					humidityChart.update();
				}
			}
		</script>
	</body>
</html>
